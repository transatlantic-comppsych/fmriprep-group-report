<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script type="text/javascript">
  var subjs = []
  function updateCounts(){
    var counts = {report:{"-1":0, "1":0, "0":0}}

    subjs.forEach(function(val, idx, arr){
      counts.report[val.report] += 1;
    })

    $("#nrpass").text(counts.report["1"])
    $("#nrfail").text(counts.report["0"])
    $("#nrtodo").text(counts.report["-1"])
  }

  function qc_update(run_id, stage, value) {
    if (stage == 'report') {
      subjs[run_id][stage] = parseInt(value)
      updateCounts();
    }
    else {
      subjs[run_id][stage] = value
    }
  }

  function update_all(stage, value) {
    subjs.forEach( subj => {subj[stage]=value})
  }

  function get_csv(items) {
    // https://stackoverflow.com/questions/44396943/generate-a-csv-file-from-a-javascript-array-of-objects
    let csv = ''

    // Loop the array of objects
    for(let row = 0; row < items.length; row++){
        let keysAmount = Object.keys(items[row]).length
        let keysCounter = 0

        // If this is the first row, generate the headings
        if(row === 0){

           // Loop each property of the object
           for(let key in items[row]){

              // This is to not add a comma at the last cell
              // The '\r\n' adds a new line
              csv += key + (keysCounter+1 < keysAmount ? '\t' : '\r\n' )
              keysCounter++
           }
           let keysCounterb = 0
           for(let key in items[row]){
               csv += items[row][key] + (keysCounterb+1 < keysAmount ? '\t' : '\r\n' )
               keysCounterb++
           }
        }else{
           for(let key in items[row]){
               csv += items[row][key] + (keysCounter+1 < keysAmount ? '\t' : '\r\n' )
               keysCounter++
           }
        }

        keysCounter = 0
    }

    // Once we are done looping, download the .csv by creating a link
    // if a link has already been created, update it
    if (document.querySelector('#download-csv') == null){
      let link = document.createElement('a')
      link.id = 'download-csv'
      link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv));
      link.setAttribute('download', 'consolidated_MNI152NLin2009cAsym_000.tsv');
      document.body.appendChild(link)
    } else {
      let link = document.querySelector('#download-csv')
      link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv));
      link.setAttribute('download', 'consolidated_MNI152NLin2009cAsym_000.tsv');
    }
    document.querySelector('#download-csv').click()
  }

  function parse_id(idstr) {
    return idstr.split('_')[0].split('-')[1]
  }

  var observer = new IntersectionObserver(function(entries, observer) {
      entries.forEach(entry => {
        eid = parse_id(entry.target.id)
        if (entry['intersectionRatio'] == 1 && subjs[eid]['been_on_screen'] == false) {
          subjs[eid]['been_on_screen'] = true
        }
        else if (entry['intersectionRatio'] == 0 && subjs[eid]['been_on_screen'] == true && subjs[eid]['report'] == -1) {
          subjs[eid]['report'] = 1
          observer.unobserve(entry.target)
          updateCounts();
          radioid = 'inlineRadio' + eid
          document.querySelectorAll('[name=' + radioid + ']')[0].checked = true
        }
        /* Here's where we deal with every intersection */
      });
    }
  , {root:document.querySelector('#scrollArea'), threshold:[0,1]});

 </script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<style type="text/css">
.sub-report-title {}
.run-title {}

h1 { padding-top: 35px; }
h2 { padding-top: 20px; }
h3 { padding-top: 15px; }

.elem-desc {}
.elem-caption {
    margin-top: 15px
    margin-bottom: 0;
}
.elem-filename {}

div.elem-image {
  width: 100%;
  page-break-before:always;
}

.elem-image object.svg-reportlet {
    width: 100%;
    padding-bottom: 5px;
}
body {
    padding: 65px 10px 10px;
}

.boiler-html {
    font-family: "Bitstream Charter", "Georgia", Times;
    margin: 20px 25px;
    padding: 10px;
    background-color: #F8F9FA;
}

div#boilerplate pre {
    margin: 20px 25px;
    padding: 10px;
    background-color: #F8F9FA;
}

</style>
</head>
<body>
<nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
        <div class="navbar-header">
           Ratings: <span id="nrpass" class="badge badge-success">0</span> <span id="nrfail" class="badge badge-danger">0</span> <span id="nrtodo" class="badge badge-warning">0</span>
         </div>
         <div class="navbar-text">
           <button type="button" class="btn btn-info btn-sm" id="csv_download" onclick="get_csv(subjs)">Download TSV</button>

         </div>
</div>
</nav>

 <p> Initials: <input type="text" id="initials_box" oninput="update_all('rater', this.value)"></p>


    <div id="id-0_filename-sub-20900_acq-mprage_rec-prenorm_run-1_space-MNI152NLin2009cAsym_T1w">
      <script type="text/javascript">
        var subj_qc = {"idx": 0, "subject": "20900", "acquisition": "mprage", "reconstruction": "prenorm", "run": 1, "suffix": "T1w", "space": "MNI152NLin2009cAsym", "desc": NaN, "session": NaN, "report_type": "MNI152NLin2009cAsym", "chunk": 0, "been_on_screen": false, "rater": NaN, "report": NaN, "note": NaN}
      </script>
       <h2>idx-0: subject <span class="bids-entity">20900</span>, acquisition <span class="bids-entity">mprage</span>, reconstruction <span class="bids-entity">prenorm</span>, run <span class="bids-entity">1</span>, suffix <span class="bids-entity">T1w</span>, space <span class="bids-entity">MNI152NLin2009cAsym</span></h2>
      <div class="radio">
        <label><input type="radio" name="inlineRadio0" id="inlineRating1" value="1" onclick="qc_update(0, 'report', this.value)"> Good </label>
        <label><input type="radio" name="inlineRadio0" id="inlineRating0" value="0" onclick="qc_update(0, 'report', this.value)"> Bad</label>
      </div>
      <p> Notes: <input type="text" id="box0" oninput="qc_update(0, 'note', this.value)"></p>
      <object class="svg-reportlet" type="image/svg+xml" data="./sub-20900/figures/sub-20900_acq-mprage_rec-prenorm_run-1_space-MNI152NLin2009cAsym_T1w.svg"> </object>
    </div>
    <script type="text/javascript">
      subj_qc["report"] = -1
      subjs.push(subj_qc)
    </script>
    

    <div id="id-1_filename-sub-22293_acq-mprage_rec-prenorm_run-1_space-MNI152NLin2009cAsym_T1w">
      <script type="text/javascript">
        var subj_qc = {"idx": 1, "subject": "22293", "acquisition": "mprage", "reconstruction": "prenorm", "run": 1, "suffix": "T1w", "space": "MNI152NLin2009cAsym", "desc": NaN, "session": NaN, "report_type": "MNI152NLin2009cAsym", "chunk": 0, "been_on_screen": false, "rater": NaN, "report": NaN, "note": NaN}
      </script>
       <h2>idx-1: subject <span class="bids-entity">22293</span>, acquisition <span class="bids-entity">mprage</span>, reconstruction <span class="bids-entity">prenorm</span>, run <span class="bids-entity">1</span>, suffix <span class="bids-entity">T1w</span>, space <span class="bids-entity">MNI152NLin2009cAsym</span></h2>
      <div class="radio">
        <label><input type="radio" name="inlineRadio1" id="inlineRating1" value="1" onclick="qc_update(1, 'report', this.value)"> Good </label>
        <label><input type="radio" name="inlineRadio1" id="inlineRating0" value="0" onclick="qc_update(1, 'report', this.value)"> Bad</label>
      </div>
      <p> Notes: <input type="text" id="box1" oninput="qc_update(1, 'note', this.value)"></p>
      <object class="svg-reportlet" type="image/svg+xml" data="./sub-22293/figures/sub-22293_acq-mprage_rec-prenorm_run-1_space-MNI152NLin2009cAsym_T1w.svg"> </object>
    </div>
    <script type="text/javascript">
      subj_qc["report"] = -1
      subjs.push(subj_qc)
    </script>
    
<script type="text/javascript">
    function toggle(id) {
        var element = document.getElementById(id);
        if(element.style.display == 'block')
            element.style.display = 'none';
        else
            element.style.display = 'block';
    }

</script>
<script>

updateCounts();
document.querySelectorAll('[id^="id"]').forEach(img => {observer.observe(img)})

</script>
</body>
</html>